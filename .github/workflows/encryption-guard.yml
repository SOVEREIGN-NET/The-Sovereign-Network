name: Encryption Guard (Issue #490)

# Prevents protocols from bypassing ProtocolEncryption trait

on:
  push:
    branches: [main, development]
  pull_request:
    branches: [main, development]

jobs:
  encryption-security-checks:
    runs-on: ubuntu-latest
    name: Verify encryption architecture compliance

    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      # Check 1: No direct lib_crypto encryption calls in protocol implementations
      - name: 'Check 1: No direct lib_crypto calls in protocols'
        run: |
          echo "Checking for direct lib_crypto encryption bypasses..."

          # Find any direct calls to lib_crypto encryption functions
          VIOLATIONS=$(grep -r "lib_crypto::symmetric::chacha20::encrypt_data\|lib_crypto::symmetric::chacha20::decrypt_data\|lib_crypto::symmetric::aes" \
            lib-network/src/protocols \
            --include="*.rs" \
            -n | grep -v test | grep -v "^\s*//")

          if [ ! -z "$VIOLATIONS" ]; then
            echo "❌ VIOLATION: Direct lib_crypto calls found in protocols!"
            echo "These should use ProtocolEncryption adapters instead:"
            echo "$VIOLATIONS"
            exit 1
          fi
          echo "✅ PASS: No direct lib_crypto calls in protocols"

      # Check 2: All protocols use ProtocolEncryption trait
      - name: 'Check 2: Protocols use ProtocolEncryption adapters'
        run: |
          echo "Checking that all protocols implement/use ProtocolEncryption trait..."

          PROTOCOLS=("bluetooth" "zhtp" "wifi_direct" "quic" "lorawan" "satellite")

          for proto in "${PROTOCOLS[@]}"; do
            if [ -d "lib-network/src/protocols/$proto" ]; then
              # Check for encryption adapter file
              if [ -f "lib-network/src/protocols/$proto/${proto}_encryption.rs" ] || \
                 [ -f "lib-network/src/protocols/$proto/zhtp_mesh_encryption.rs" ] || \
                 [ -f "lib-network/src/protocols/$proto/quic_encryption.rs" ] || \
                 [ -f "lib-network/src/protocols/$proto/bluetooth_encryption.rs" ]; then
                echo "✅ $proto has encryption adapter"
              else
                # Some protocols might not have separate encryption files (check implementation)
                echo "⚠️  $proto - verify has ProtocolEncryption implementation"
              fi
            fi
          done

      # Check 3: No unsafe code in core encryption
      - name: 'Check 3: No unsafe code in encryption core'
        run: |
          echo "Checking for unsafe code in encryption module..."

          UNSAFE=$(grep -r "unsafe" \
            lib-network/src/encryption/mod.rs \
            --include="*.rs" \
            2>/dev/null || true)

          if [ ! -z "$UNSAFE" ]; then
            echo "⚠️  WARNING: unsafe code found in encryption core:"
            echo "$UNSAFE"
          else
            echo "✅ PASS: No unsafe code in encryption core"
          fi

      # Check 4: AAD usage in adapters
      - name: 'Check 4: All adapters support AAD'
        run: |
          echo "Checking that adapters use AAD for domain separation..."

          ADAPTERS=("bluetooth_encryption" "zhtp_mesh_encryption" "wifi_direct_encryption" "quic_encryption" "lorawan_encryption")

          for adapter in "${ADAPTERS[@]}"; do
            FILE=$(find lib-network/src/protocols -name "${adapter}.rs" | head -1)
            if [ ! -z "$FILE" ]; then
              if grep -q "aad\|AAD" "$FILE"; then
                echo "✅ $adapter uses AAD for domain separation"
              else
                echo "⚠️  $adapter - verify AAD implementation"
              fi
            fi
          done

      # Check 5: Trait implementation verification
      - name: 'Check 5: Verify ProtocolEncryption trait implementation'
        run: |
          echo "Checking ProtocolEncryption trait signatures..."

          # Check trait uses &self (stateless)
          if grep -q "fn encrypt(&self.*aad" lib-network/src/encryption/mod.rs; then
            echo "✅ PASS: encrypt() uses &self with AAD"
          else
            echo "❌ FAIL: encrypt() signature incorrect"
            exit 1
          fi

          if grep -q "fn decrypt(&self.*aad" lib-network/src/encryption/mod.rs; then
            echo "✅ PASS: decrypt() uses &self with AAD"
          else
            echo "❌ FAIL: decrypt() signature incorrect"
            exit 1
          fi

      # Check 6: Run encryption tests
      - name: 'Check 6: Run encryption tests'
        run: |
          cd lib-network
          cargo test --lib encryption --lib protocols 2>&1 | tee test-output.txt

          # Count test results
          PASSED=$(grep "test result:" test-output.txt | grep "ok" | wc -l)
          FAILED=$(grep "test result:" test-output.txt | grep "FAILED" | wc -l)

          if [ "$FAILED" -gt 0 ]; then
            echo "❌ Some tests failed!"
            exit 1
          fi

          echo "✅ All encryption and protocol tests passed"

      # Check 7: Documentation verification
      - name: 'Check 7: Verify encryption documentation'
        run: |
          echo "Checking encryption documentation..."

          if grep -q "Associated Authenticated Data\|AAD\|domain separation" \
            lib-network/src/encryption/mod.rs; then
            echo "✅ Documentation mentions AAD and domain separation"
          else
            echo "⚠️  WARNING: Consider updating encryption documentation with AAD examples"
          fi

      - name: Summary
        if: always()
        run: |
          echo ""
          echo "╔════════════════════════════════════════════════════════════╗"
          echo "║ ENCRYPTION GUARD CHECK COMPLETE                           ║"
          echo "║ Issue #490: Unified Protocol Encryption Architecture      ║"
          echo "╚════════════════════════════════════════════════════════════╝"
          echo ""
          echo "Phase Status:"
          echo "  ✅ Phase 1: ProtocolEncryption Trait (COMPLETE)"
          echo "  ✅ Phase 2: Protocol Adapters (COMPLETE)"
          echo "  ✅ Phase 3: Protocol Refactoring (COMPLETE)"
          echo "  ⏳ Phase 4: CI Guards & Final Review (IN PROGRESS)"
          echo ""
          echo "Security Requirements:"
          echo "  ✅ Domain Separation via AAD"
          echo "  ✅ Stateless Design (&self)"
          echo "  ✅ Atomic Statistics (thread-safe)"
          echo "  ✅ Trait-based Encryption"
          echo ""
